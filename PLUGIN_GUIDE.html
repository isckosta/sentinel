<h1>Guia de Desenvolvimento de Plugins</h1>
<h2>Vis√£o Geral</h2>
<p>Plugins permitem estender o comportamento do Sentinel com l√≥gica customizada de avalia√ß√£o de risco e rea√ß√£o a eventos.</p>
<h2>Estrutura B√°sica</h2>
<p>Um plugin √© um m√≥dulo JavaScript/TypeScript que exporta um objeto com a seguinte estrutura:</p>
<pre><code class="language-javascript">module.exports = {
  name: &#39;my-plugin&#39;,
  
  evaluate: (command, currentScore) =&gt; {
    // L√≥gica de avalia√ß√£o
    return adjustedScore;
  },
  
  onEvent: (event) =&gt; {
    // Rea√ß√£o a eventos (opcional)
  }
};
</code></pre>
<h2>Interface do Plugin</h2>
<h3><code>name: string</code></h3>
<p>Nome √∫nico do plugin. Usado para logging e debugging.</p>
<h3><code>evaluate(command, currentScore): number</code></h3>
<p>Fun√ß√£o principal que avalia o comando e retorna um score ajustado.</p>
<p><strong>Par√¢metros</strong>:</p>
<ul>
<li><p><code>command: ParsedCommand</code></p>
<pre><code class="language-typescript">{
  binary: string;          // Ex: &#39;git&#39;, &#39;npm&#39;, &#39;docker&#39;
  args: string[];          // Ex: [&#39;push&#39;, &#39;--force&#39;]
  fullCommand: string;     // Ex: &#39;git push --force&#39;
  currentBranch: string | null;  // Ex: &#39;main&#39;, &#39;feature/xyz&#39;
  currentDirectory: string;      // Ex: &#39;/home/user/project&#39;
  environment: string;           // Ex: &#39;production&#39;, &#39;development&#39;
}
</code></pre>
</li>
<li><p><code>currentScore: number</code> - Score atual (0-100)</p>
</li>
</ul>
<p><strong>Retorno</strong>: Novo score (0-100)</p>
<h3><code>onEvent(event): void</code> (opcional)</h3>
<p>Fun√ß√£o chamada ap√≥s cada decis√£o, permitindo rea√ß√£o a eventos.</p>
<p><strong>Par√¢metros</strong>:</p>
<ul>
<li><code>event: TelemetryEvent</code><pre><code class="language-typescript">{
  timestamp: Date;
  command: string;
  riskScore: number;
  riskLevel: &#39;safe&#39; | &#39;warning&#39; | &#39;critical&#39;;
  decision: &#39;allowed&#39; | &#39;blocked&#39; | &#39;confirmed&#39;;
  executed: boolean;
}
</code></pre>
</li>
</ul>
<h2>Exemplos</h2>
<h3>1. Plugin Simples - Verifica√ß√£o de Branch</h3>
<pre><code class="language-javascript">// plugins/branch-protection.js
module.exports = {
  name: &#39;branch-protection&#39;,
  
  evaluate: (command, currentScore) =&gt; {
    // Aumenta score para opera√ß√µes em branches protegidas
    const protectedBranches = [&#39;main&#39;, &#39;master&#39;, &#39;production&#39;];
    
    if (protectedBranches.includes(command.currentBranch)) {
      console.log(`[${this.name}] Protected branch detected: ${command.currentBranch}`);
      return currentScore + 20;
    }
    
    return currentScore;
  }
};
</code></pre>
<h3>2. Plugin com Palavras-Chave</h3>
<pre><code class="language-javascript">// plugins/keyword-detector.js
module.exports = {
  name: &#39;keyword-detector&#39;,
  
  evaluate: (command, currentScore) =&gt; {
    const dangerousKeywords = {
      &#39;production&#39;: 15,
      &#39;delete&#39;: 20,
      &#39;drop&#39;: 25,
      &#39;truncate&#39;: 20,
      &#39;force&#39;: 15
    };
    
    let score = currentScore;
    
    for (const [keyword, penalty] of Object.entries(dangerousKeywords)) {
      if (command.fullCommand.toLowerCase().includes(keyword)) {
        console.log(`[${this.name}] Dangerous keyword detected: ${keyword} (+${penalty})`);
        score += penalty;
      }
    }
    
    return score;
  }
};
</code></pre>
<h3>3. Plugin com An√°lise de Hor√°rio</h3>
<pre><code class="language-javascript">// plugins/time-guardian.js
module.exports = {
  name: &#39;time-guardian&#39;,
  
  evaluate: (command, currentScore) =&gt; {
    const hour = new Date().getHours();
    const day = new Date().getDay();
    
    let score = currentScore;
    
    // Hor√°rio de trabalho (9h-18h)
    const isWorkingHours = hour &gt;= 9 &amp;&amp; hour &lt; 18;
    
    // Fim de semana
    const isWeekend = day === 0 || day === 6;
    
    // Opera√ß√µes cr√≠ticas fora do hor√°rio
    if (!isWorkingHours &amp;&amp; command.environment === &#39;production&#39;) {
      console.log(`[${this.name}] Production operation outside working hours (+25)`);
      score += 25;
    }
    
    // Deploys no fim de semana
    if (isWeekend &amp;&amp; command.fullCommand.includes(&#39;deploy&#39;)) {
      console.log(`[${this.name}] Weekend deployment detected (+20)`);
      score += 20;
    }
    
    return score;
  }
};
</code></pre>
<h3>4. Plugin com Notifica√ß√µes</h3>
<pre><code class="language-javascript">// plugins/slack-notifier.js
const https = require(&#39;https&#39;);

module.exports = {
  name: &#39;slack-notifier&#39;,
  
  evaluate: (command, currentScore) =&gt; {
    // N√£o modifica o score, apenas observa
    return currentScore;
  },
  
  onEvent: (event) =&gt; {
    // Notifica Slack apenas para comandos cr√≠ticos executados
    if (event.riskLevel === &#39;critical&#39; &amp;&amp; event.executed) {
      sendSlackNotification({
        text: `üö® ALERTA: Comando cr√≠tico executado!`,
        fields: [
          { title: &#39;Comando&#39;, value: event.command },
          { title: &#39;Score&#39;, value: event.riskScore },
          { title: &#39;Timestamp&#39;, value: event.timestamp.toISOString() }
        ]
      });
    }
  }
};

function sendSlackNotification(message) {
  const webhookUrl = process.env.SLACK_WEBHOOK_URL;
  if (!webhookUrl) return;
  
  const data = JSON.stringify(message);
  
  const options = {
    method: &#39;POST&#39;,
    headers: {
      &#39;Content-Type&#39;: &#39;application/json&#39;,
      &#39;Content-Length&#39;: data.length
    }
  };
  
  const req = https.request(webhookUrl, options);
  req.write(data);
  req.end();
}
</code></pre>
<h3>5. Plugin com An√°lise de Contexto</h3>
<pre><code class="language-javascript">// plugins/context-analyzer.js
const fs = require(&#39;fs&#39;);
const path = require(&#39;path&#39;);

module.exports = {
  name: &#39;context-analyzer&#39;,
  
  evaluate: (command, currentScore) =&gt; {
    let score = currentScore;
    
    // Verifica se existe arquivo de configura√ß√£o de produ√ß√£o
    const prodConfigExists = fs.existsSync(
      path.join(command.currentDirectory, &#39;.env.production&#39;)
    );
    
    if (prodConfigExists &amp;&amp; command.environment === &#39;production&#39;) {
      console.log(`[${this.name}] Production config detected (+10)`);
      score += 10;
    }
    
    // Verifica se est√° em diret√≥rio de infraestrutura
    if (command.currentDirectory.includes(&#39;infrastructure&#39;) ||
        command.currentDirectory.includes(&#39;terraform&#39;)) {
      console.log(`[${this.name}] Infrastructure directory detected (+15)`);
      score += 15;
    }
    
    // Verifica se h√° mudan√ßas n√£o commitadas
    try {
      const { execSync } = require(&#39;child_process&#39;);
      const status = execSync(&#39;git status --porcelain&#39;, { encoding: &#39;utf-8&#39; });
      
      if (status.trim().length &gt; 0) {
        console.log(`[${this.name}] Uncommitted changes detected (+5)`);
        score += 5;
      }
    } catch (error) {
      // N√£o √© um reposit√≥rio git ou erro ao executar
    }
    
    return score;
  }
};
</code></pre>
<h3>6. Plugin TypeScript</h3>
<pre><code class="language-typescript">// plugins/advanced-analyzer.ts
import { Plugin, ParsedCommand, TelemetryEvent } from &#39;@mhsolutions/sentinel&#39;;

interface AnalysisResult {
  score: number;
  reasons: string[];
}

class AdvancedAnalyzer implements Plugin {
  name = &#39;advanced-analyzer&#39;;
  
  private patterns = new Map&lt;RegExp, number&gt;([
    [/rm\s+-rf\s+\//, 100],
    [/drop\s+database/, 80],
    [/kubectl\s+delete/, 60],
  ]);
  
  evaluate(command: ParsedCommand, currentScore: number): number {
    const result = this.analyzeCommand(command);
    return currentScore + result.score;
  }
  
  private analyzeCommand(command: ParsedCommand): AnalysisResult {
    const reasons: string[] = [];
    let score = 0;
    
    for (const [pattern, penalty] of this.patterns) {
      if (pattern.test(command.fullCommand)) {
        score += penalty;
        reasons.push(`Matched dangerous pattern: ${pattern.source}`);
      }
    }
    
    return { score, reasons };
  }
  
  onEvent(event: TelemetryEvent): void {
    if (event.riskLevel === &#39;critical&#39;) {
      this.logToExternalSystem(event);
    }
  }
  
  private logToExternalSystem(event: TelemetryEvent): void {
    // Implementar integra√ß√£o com sistema externo
    console.log(`[${this.name}] Logging to external system:`, event);
  }
}

export = new AdvancedAnalyzer();
</code></pre>
<h2>Configura√ß√£o</h2>
<p>Adicione o plugin ao arquivo <code>sentinel.yml</code>:</p>
<pre><code class="language-yaml">plugins:
  - &quot;./plugins/branch-protection.js&quot;
  - &quot;./plugins/keyword-detector.js&quot;
  - &quot;./plugins/time-guardian.js&quot;
  - &quot;./plugins/slack-notifier.js&quot;
</code></pre>
<h2>Boas Pr√°ticas</h2>
<h3>1. Retorne Sempre um N√∫mero</h3>
<pre><code class="language-javascript">// ‚úÖ Correto
evaluate: (command, currentScore) =&gt; {
  return currentScore + 10;
}

// ‚ùå Errado
evaluate: (command, currentScore) =&gt; {
  currentScore + 10; // Sem return
}
</code></pre>
<h3>2. N√£o Modifique o Objeto Command</h3>
<pre><code class="language-javascript">// ‚úÖ Correto
evaluate: (command, currentScore) =&gt; {
  const branch = command.currentBranch;
  return currentScore;
}

// ‚ùå Errado
evaluate: (command, currentScore) =&gt; {
  command.currentBranch = &#39;modified&#39;; // N√£o modifique
  return currentScore;
}
</code></pre>
<h3>3. Trate Erros Graciosamente</h3>
<pre><code class="language-javascript">evaluate: (command, currentScore) =&gt; {
  try {
    // L√≥gica que pode falhar
    const result = riskyOperation();
    return currentScore + result;
  } catch (error) {
    console.error(`[${this.name}] Error:`, error);
    return currentScore; // Retorna score original
  }
}
</code></pre>
<h3>4. Use Logging para Debug</h3>
<pre><code class="language-javascript">evaluate: (command, currentScore) =&gt; {
  console.log(`[${this.name}] Evaluating: ${command.fullCommand}`);
  console.log(`[${this.name}] Current score: ${currentScore}`);
  
  const newScore = currentScore + 10;
  
  console.log(`[${this.name}] New score: ${newScore}`);
  return newScore;
}
</code></pre>
<h3>5. Documente Seu Plugin</h3>
<pre><code class="language-javascript">/**
 * Branch Protection Plugin
 * 
 * Increases risk score for operations on protected branches.
 * 
 * Protected branches: main, master, production
 * Penalty: +20 points
 * 
 * @example
 * // Command on main branch
 * git push origin main
 * // Score increased by 20
 */
module.exports = {
  name: &#39;branch-protection&#39;,
  evaluate: (command, currentScore) =&gt; {
    // ...
  }
};
</code></pre>
<h2>Testing de Plugins</h2>
<p>Crie testes para seus plugins:</p>
<pre><code class="language-javascript">// plugins/__tests__/branch-protection.test.js
const plugin = require(&#39;../branch-protection&#39;);

describe(&#39;Branch Protection Plugin&#39;, () =&gt; {
  test(&#39;should increase score for main branch&#39;, () =&gt; {
    const command = {
      binary: &#39;git&#39;,
      args: [&#39;push&#39;],
      fullCommand: &#39;git push&#39;,
      currentBranch: &#39;main&#39;,
      currentDirectory: &#39;/test&#39;,
      environment: &#39;development&#39;
    };
    
    const result = plugin.evaluate(command, 50);
    expect(result).toBe(70); // 50 + 20
  });
  
  test(&#39;should not change score for feature branch&#39;, () =&gt; {
    const command = {
      binary: &#39;git&#39;,
      args: [&#39;push&#39;],
      fullCommand: &#39;git push&#39;,
      currentBranch: &#39;feature/test&#39;,
      currentDirectory: &#39;/test&#39;,
      environment: &#39;development&#39;
    };
    
    const result = plugin.evaluate(command, 50);
    expect(result).toBe(50);
  });
});
</code></pre>
<h2>Distribui√ß√£o</h2>
<h3>Como Pacote NPM</h3>
<ol>
<li>Crie um pacote separado:</li>
</ol>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;sentinel-plugin-mybranch&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;peerDependencies&quot;: {
    &quot;@mhsolutions/sentinel&quot;: &quot;^0.1.0&quot;
  }
}
</code></pre>
<ol start="2">
<li>Publique no NPM:</li>
</ol>
<pre><code class="language-bash">npm publish
</code></pre>
<ol start="3">
<li>Usu√°rios instalam:</li>
</ol>
<pre><code class="language-bash">npm install sentinel-plugin-mybranch
</code></pre>
<ol start="4">
<li>Configure:</li>
</ol>
<pre><code class="language-yaml">plugins:
  - &quot;node_modules/sentinel-plugin-mybranch&quot;
</code></pre>
<h2>Recursos Avan√ßados</h2>
<h3>Acesso a Vari√°veis de Ambiente</h3>
<pre><code class="language-javascript">evaluate: (command, currentScore) =&gt; {
  const apiKey = process.env.MY_PLUGIN_API_KEY;
  if (!apiKey) {
    console.warn(`[${this.name}] API key not configured`);
    return currentScore;
  }
  // Usar API key...
}
</code></pre>
<h3>Persist√™ncia de Estado</h3>
<pre><code class="language-javascript">const fs = require(&#39;fs&#39;);
const path = require(&#39;path&#39;);

const stateFile = path.join(process.env.HOME, &#39;.sentinel&#39;, &#39;my-plugin-state.json&#39;);

function loadState() {
  if (fs.existsSync(stateFile)) {
    return JSON.parse(fs.readFileSync(stateFile, &#39;utf-8&#39;));
  }
  return {};
}

function saveState(state) {
  fs.writeFileSync(stateFile, JSON.stringify(state, null, 2));
}

module.exports = {
  name: &#39;stateful-plugin&#39;,
  
  evaluate: (command, currentScore) =&gt; {
    const state = loadState();
    state.commandCount = (state.commandCount || 0) + 1;
    saveState(state);
    
    return currentScore;
  }
};
</code></pre>
<h2>Troubleshooting</h2>
<h3>Plugin N√£o Carrega</h3>
<ul>
<li>Verifique o path no <code>sentinel.yml</code></li>
<li>Confirme que o arquivo existe</li>
<li>Verifique erros de sintaxe no plugin</li>
</ul>
<h3>Plugin N√£o Afeta Score</h3>
<ul>
<li>Confirme que est√° retornando um n√∫mero</li>
<li>Verifique logs com <code>console.log</code></li>
<li>Teste isoladamente</li>
</ul>
<h3>Erros em Produ√ß√£o</h3>
<ul>
<li>Sempre use try/catch</li>
<li>Retorne score original em caso de erro</li>
<li>Log erros para debugging</li>
</ul>
<h2>Exemplos da Comunidade</h2>
<p>Veja mais exemplos em:</p>
<ul>
<li><a href="https://github.com/mhsolutions/sentinel-plugins">Sentinel Plugins Repository</a></li>
<li><a href="https://github.com/topics/sentinel-plugin">Community Plugins</a></li>
</ul>
<h2>Contribuindo</h2>
<p>Compartilhe seus plugins com a comunidade:</p>
<ol>
<li>Publique no NPM com prefixo <code>sentinel-plugin-</code></li>
<li>Adicione tag <code>sentinel-plugin</code> no GitHub</li>
<li>Abra PR para adicionar √† lista de plugins recomendados</li>
</ol>

