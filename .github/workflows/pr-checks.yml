name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check PR title
        if: ${{ github.event.pull_request.user.type != 'Bot' }}
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            O tÃ­tulo do PR deve comeÃ§ar com letra maiÃºscula.
            Exemplo: "feat: Adiciona nova funcionalidade"
      
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;
            
            let size = 'small';
            let emoji = 'ğŸŸ¢';
            let message = 'PR pequeno - fÃ¡cil de revisar!';
            
            if (total > 1000) {
              size = 'extra-large';
              emoji = 'ğŸ”´';
              message = 'PR muito grande - considere dividir em PRs menores';
            } else if (total > 500) {
              size = 'large';
              emoji = 'ğŸŸ ';
              message = 'PR grande - pode ser difÃ­cil de revisar';
            } else if (total > 200) {
              size = 'medium';
              emoji = 'ğŸŸ¡';
              message = 'PR mÃ©dio';
            }
            
            core.summary
              .addHeading(`${emoji} Tamanho do PR: ${size}`)
              .addRaw(`\n**Total de mudanÃ§as**: ${total} linhas\n`)
              .addRaw(`- AdiÃ§Ãµes: ${additions}\n`)
              .addRaw(`- DeleÃ§Ãµes: ${deletions}\n`)
              .addRaw(`\n${message}`)
              .write();
      
      - name: Check for breaking changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title || '';
            
            const hasBreaking = 
              title.includes('BREAKING CHANGE') ||
              title.includes('!:') ||
              body.includes('BREAKING CHANGE');
            
            if (hasBreaking) {
              core.warning('âš ï¸ Este PR contÃ©m BREAKING CHANGES!');
              core.summary
                .addHeading('âš ï¸ Breaking Changes Detectadas')
                .addRaw('\nEste PR contÃ©m mudanÃ§as que quebram compatibilidade.\n')
                .addRaw('Certifique-se de:\n')
                .addList([
                  'Atualizar a versÃ£o major no package.json',
                  'Documentar as breaking changes no CHANGELOG.md',
                  'Atualizar a documentaÃ§Ã£o afetada',
                  'Adicionar migration guide se necessÃ¡rio'
                ])
                .write();
            }
      
      - name: Check for tests
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const hasSourceChanges = files.some(f => 
              f.filename.startsWith('src/') && 
              f.filename.endsWith('.ts') &&
              !f.filename.includes('.test.ts')
            );
            
            const hasTestChanges = files.some(f => 
              f.filename.includes('.test.ts') ||
              f.filename.startsWith('tests/')
            );
            
            if (hasSourceChanges && !hasTestChanges) {
              core.warning('âš ï¸ Este PR modifica cÃ³digo fonte mas nÃ£o adiciona/atualiza testes');
              core.summary
                .addHeading('âš ï¸ Testes Ausentes')
                .addRaw('\nEste PR modifica cÃ³digo fonte mas nÃ£o inclui testes.\n')
                .addRaw('Considere adicionar testes para as mudanÃ§as realizadas.\n')
                .write();
            }
      
      - name: Check for documentation
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const hasSourceChanges = files.some(f => 
              f.filename.startsWith('src/') && 
              f.filename.endsWith('.ts')
            );
            
            const hasDocChanges = files.some(f => 
              f.filename.endsWith('.md') ||
              f.filename.startsWith('docs/')
            );
            
            if (hasSourceChanges && !hasDocChanges) {
              core.notice('ğŸ’¡ Considere atualizar a documentaÃ§Ã£o se necessÃ¡rio');
            }
      
      - name: Welcome first-time contributors
        uses: actions/first-interaction@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          pr-message: |
            ğŸ‘‹ Obrigado pela sua primeira contribuiÃ§Ã£o ao Sentinel!
            
            Aqui estÃ£o algumas dicas:
            - Certifique-se de que todos os testes passam
            - Siga o guia de estilo do projeto
            - Atualize a documentaÃ§Ã£o se necessÃ¡rio
            - Seja paciente - revisaremos seu PR em breve!
            
            Se vocÃª tiver dÃºvidas, nÃ£o hesite em perguntar. Estamos aqui para ajudar! ğŸ›¡ï¸
